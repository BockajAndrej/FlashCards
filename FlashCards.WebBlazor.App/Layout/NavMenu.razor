@using IdentityModel
@using Microsoft.AspNetCore.Components.WebAssembly.Authentication

@inject NavigationManager Navigation;

<MudAppBar Class="appbar-specific" Dense Elevation="0">
    <MudAvatar Class="appbar-specific-mudavatar" Square>
        <MudImage Src="Images/flash-card.png"></MudImage>
    </MudAvatar>
    
    <MudDivider Style="margin: 0 15px; height: 60%;" Vertical="true"/>
    
    <AuthorizeView>
        <Authorized>
            <MudStack Row StretchItems="StretchItems.All" Style="margin: 0 auto; align-items: center;"> 
                <MudNavLink 
                    Class="appbar-specific-buttons" 
                    Match="NavLinkMatch.Prefix" 
                    Href="/CollectionPage"
                    Icon="@Icons.Material.Filled.MenuBook"
                    IconColor="Color.Inherit"
                    ActiveClass="appbar-specific-buttons-matchingPrefix">Collections
                </MudNavLink>
                <MudNavLink 
                    Class="appbar-specific-buttons" 
                    Match="NavLinkMatch.Prefix" 
                    Href="/CollectionEditPage/create"
                    Icon="@Icons.Material.Filled.Add" 
                    IconColor="Color.Inherit"
                    ActiveClass="appbar-specific-buttons-matchingPrefix">Create Collection
                </MudNavLink>
                <MudNavLink 
                    Class="appbar-specific-buttons nav-link-appbar" 
                    Match="NavLinkMatch.Prefix" 
                    Href="/StatisticPage"
                    Icon="@Icons.Material.Filled.BarChart" 
                    IconColor="Color.Inherit"
                    ActiveClass="appbar-specific-buttons-matchingPrefix">Statistics
                </MudNavLink>
            </MudStack>
        </Authorized>
    </AuthorizeView>
    


    <MudSpacer/>
    <AuthorizeView>
        <Authorizing>
            <MudIconButton Class="appbar-specific-text" Icon="@Icons.Material.Filled.Login"
                           Href="authentication/login"></MudIconButton>
        </Authorizing>
        <Authorized>
            <MudMenu Style="border-radius: 15px;" OpenChanged="@ToggleProfile" RelativeWidth="DropdownWidth.Adaptive"
                     AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                <ActivatorContent>
                    <MudAvatar Class="appbar-specific-mudavatar">
                        <MudImage Src="@ProfileImage" Alt="Profile"/>
                    </MudAvatar>
                </ActivatorContent>
                <ChildContent>
                    <MudStack Style="margin-left: 10px; margin-right: 50px; margin-top: 5px; margin-bottom: 5px;" Spacing="1">
                        <MudText Typo="Typo.h6" Style="color:#ffffff;"> @UserName</MudText> 
                    </MudStack>
                    <MudDivider Style="width: 90%; margin: 5px auto;"/>
        
                    <MudMenuItem Style="color:#ffffff;" 
                                 Href="/ProfilePage" 
                                 Icon="@Icons.Material.Filled.Person" 
                                 IconColor="Color.Tertiary">
                        Profile
                    </MudMenuItem>
        
                    <MudDivider Style="width: 90%; margin: 5px auto;"/>
        
                    <MudMenuItem Style="color:#ffffff;" 
                                 OnClick="@BeginLogOut" 
                                 Icon="@Icons.Material.Filled.Logout" 
                                 IconColor="Color.Tertiary">
                        Log out
                    </MudMenuItem>
        
                </ChildContent>
            </MudMenu>
        </Authorized>
        <NotAuthorized>
            <MudIconButton Class="appbar-specific-text" Icon="@Icons.Material.Filled.Login"
                           Href="authentication/login"></MudIconButton>
        </NotAuthorized>
    </AuthorizeView>
</MudAppBar>

@code{
    const string DefaultProfileImage = "Images/randomBoyIcon.png";

    [Inject] public AuthenticationStateProvider AuthenticationStateProvider { get; set; } = null!;
    [Parameter] public string UserName { get; set; } = "Default User";
    [Parameter] public string UserRole { get; set; } = "Default Role";
    [Parameter] public string ProfileImage { get; set; } = DefaultProfileImage;

    private bool _openProfile = true;

    protected override async Task OnInitializedAsync()
    {
        AuthenticationStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
        await GetUserInfo();
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        await GetUserInfo();
        StateHasChanged();
    }

    public void BeginLogOut()
    {
        Navigation.NavigateToLogout("authentication/logout");
    }

    private async Task GetUserInfo()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            if (user.Identity.Name != null)
                UserName = user.Identity.Name;
            else
                UserName = "Anonymous";
            var userRole = user.FindFirst(JwtClaimTypes.Role);
            if (userRole != null)
                UserRole = userRole.Value;
            else
                UserRole = "None";
            var pictureClaim = user.FindFirst(JwtClaimTypes.Picture);
            if (pictureClaim != null)
                ProfileImage = pictureClaim.Value;
            else
                ProfileImage = DefaultProfileImage;
        }
    }

    private void ToggleProfile()
    {
        _openProfile = !_openProfile;
    }

}
