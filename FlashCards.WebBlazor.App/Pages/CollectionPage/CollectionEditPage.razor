@page "/CollectionEditPage/edit/{Id:guid}"
@page "/CollectionEditPage/create"
@using FlashCards.WebBlazor.Bl.ApiClient
@using FlashCards.WebBlazor.Bl.Facades

<MudButton Style="color: var(--card-text-Primary);" StartIcon="@Icons.Material.Filled.ArrowBack"
           Size="Size.Large" OnClick="@GoBackBtn">Back
</MudButton>

<MudStack Style="margin: -30px auto;" Row StretchItems="StretchItems.Middle">
    <MudSpacer/>

    <MudButton
        Style="background-color: var(--color-action-Secondary); color: var(--card-text-Primary); border-radius: 50px;"
        ButtonType="ButtonType.Submit"
        Variant="Variant.Filled"
        Size="Size.Medium"
        OnClick="HandleSubmit">
        @if (IsSavingProcess)
        {
            <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
            <MudText Class="ms-2">Processing</MudText>
        }
        else
        {
            <MudText>
                @(Id == Guid.Empty ? "Create" : "Save")
            </MudText>
        }
    </MudButton>

    <MudSpacer/>
    <MudIconButton Style="margin: 5px auto;" Size="Size.Medium" Variant="Variant.Outlined" Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="@OnDeleteCollectionBtnClicked"/>
</MudStack>



<MudForm Model="@Model" @ref="form" ValidationDelay="0">
    <MudStack Style="margin: 50px auto; width: 90%;" Spacing="4">
        <MudTextField @bind-Value="Model.Title"
                      AdornmentColor="Color.Info"
                      Placeholder="Collection Name"
                      Required="true"
                      Clearable="true"
                      Typo="Typo.h4"
                      Variant="Variant.Text"/>

        <MudTextField @bind-Value="Model.Description"
                      AdornmentColor="Color.Info"
                      Placeholder="Description"
                      Clearable="true"
                      Variant="Variant.Text"/>

    </MudStack>

    <MudText Style="margin-left: 3%; margin-top: 20px;" Typo="Typo.h5">Cards</MudText>
    <MudDivider Style="margin: 5px auto; width: 95%;"/>

    @if (IsFilterVisible)
    {
        <div style="width: 90%; margin: 15px auto;">
            <input class="filtercomponent-specific-searchbar" type="text" placeholder="Search..."
                   @bind-value="SearchTerm"
                   @bind-value:event="oninput"
                   @bind-value:after="SearchTermChanged"/>
        </div>
    }


    <MudStack Row Style="margin: 0 auto; width: 95%" Justify="Justify.SpaceAround" Wrap="Wrap.Wrap">
        @{ int i = 0; }
        @foreach (var item in CardModels)
        {
            <MudPaper Style="padding: 15px; width: 48%; border-radius: 10px;">

                <MudStack Row StretchItems="StretchItems.Start">
                    <MudStack>
                        <MudStack Row StretchItems="StretchItems.All">
                            <MudTextField T="string" Label="Question" Variant="Variant.Text" Required="true"
                                          @bind-Value="@item.Question"/>

                            <MudSelect T="EnumCardType" @bind-Value="@item.QuestionTypeEnum" Label="Type"
                                       Variant="Variant.Text">
                                @foreach (var subItem in _cardOptions)
                                {
                                    <MudSelectItem Value="@subItem.Key">
                                        <MudIcon Icon="@subItem.Value"/>
                                    </MudSelectItem>
                                }
                            </MudSelect>

                            <MudTextField T="string" Label="Answer" Variant="Variant.Text" Required="true"
                                          @bind-Value="@item.CorrectAnswer"/>

                            <MudSelect T="EnumCardType" @bind-Value="@item.AnswerTypeEnum" Label="Type"
                                       Variant="Variant.Text">
                                @foreach (var subItem in _cardOptions)
                                {
                                    <MudSelectItem Value="@subItem.Key">
                                        <MudIcon Icon="@subItem.Value"/>
                                    </MudSelectItem>
                                }
                            </MudSelect>
                        </MudStack>

                        <MudTextField T="string" Label="Description" Variant="Variant.Text"
                                      @bind-Value="@item.Description"/>
                    </MudStack>
                    <MudIconButton Variant="Variant.Filled" Size="Size.Small" Icon="@Icons.Material.Filled.Delete"
                                   Color="Color.Primary" OnClick="@(() => RemoveCard(item))"/>
                </MudStack>
            </MudPaper>
        }
    </MudStack>
    
    <MudStack Style="width: 95%; margin: 10px auto;" Row StretchItems="StretchItems.Start">
        <MudButton StartIcon="@Icons.Material.Filled.Add" OnClick="@AddNewCard" Size="Size.Large">Add card</MudButton>
    </MudStack>

</MudForm>

@code {
    [Inject] private CollectionWebFacade CollectionWebFacade { get; set; } = null!;
    [Inject] private CardWebFacade CardWebFacade { get; set; } = null!;
    [Inject] private NavigationManager Navigation { get; set; } = null!;
    [Inject] private IJSRuntime JsRuntime { get; set; } = null!;
    [Inject] ISnackbar Snackbar { get; set; } = null!;

    [Parameter] public Guid Id { get; set; } = Guid.Empty;

    private List<CardDetailModel> CardModels { get; set; } = new();
    private List<CardDetailModel> RemovedCardModels { get; set; } = new();

    private readonly Dictionary<EnumCardType, string> _cardOptions = new()
    {
        { EnumCardType._0, Icons.Material.Filled.TextFields },
        { EnumCardType._1, Icons.Material.Filled.Image }
    };

    private CollectionDetailModel Model { get; set; } = new();
    private MudForm form = new();

    private DateTime? StartTimeDate { get; set; }
    private TimeSpan? StartTimeTime { get; set; }
    private DateTime? EndTimeDate { get; set; }
    private TimeSpan? EndTimeTime { get; set; }

    private TimeSpan DefaultOffset { get; set; } = TimeZoneInfo.Local.GetUtcOffset(DateTimeOffset.Now);

    private bool IsSavingProcess { get; set; } = false;
    private bool IsFilterVisible { get; set; } = false;

    private string SearchTerm { get; set; } = string.Empty;


    protected override async Task OnInitializedAsync()
    {
        if (Id != Guid.Empty)
        {
            Model = await CollectionWebFacade.GetByIdAsync(Id);
            CardModels.Clear();

            foreach (var card in Model.Cards)
            {
                CardModels.Add(new CardDetailModel()
                {
                    Id = card.Id,
                    Question = card.Question,
                    QuestionTypeEnum = card.QuestionTypeEnum,
                    CorrectAnswer = card.CorrectAnswer,
                    AnswerTypeEnum = card.AnswerTypeEnum,
                    Description = card.Description,
                });
            }
        }
        else
        {
            Model = new CollectionDetailModel
            {
                Title = "",
                Description = "",
                StartTimeForAcceptedAnswers = DateTimeOffset.Now,
                EndTimeForAcceptedAnswers = DateTimeOffset.Now,
                LastModifiedDateTime = DateTimeOffset.Now
            };
        }

        if (Model.StartTimeForAcceptedAnswers.HasValue)
        {
            StartTimeDate = Model.StartTimeForAcceptedAnswers.Value.DateTime;
            StartTimeTime = Model.StartTimeForAcceptedAnswers.Value.TimeOfDay;
            DefaultOffset = Model.StartTimeForAcceptedAnswers.Value.Offset;
        }

        if (Model.EndTimeForAcceptedAnswers.HasValue)
        {
            EndTimeDate = Model.EndTimeForAcceptedAnswers.Value.DateTime;
            EndTimeTime = Model.EndTimeForAcceptedAnswers.Value.TimeOfDay;
        }

        if (CardModels.Any())
            IsFilterVisible = true;
    }

    private async Task HandleSubmit()
    {
        await form.Validate();
        IsSavingProcess = true;

        if (form.IsValid)
        {
            var collectionId = await CollectionWebFacade.SaveToApiAsync(Model);

            if (collectionId == Guid.Empty)
                collectionId = Id;

            foreach (var cardDetailModel in CardModels)
            {
                cardDetailModel.CardCollectionId = collectionId;
                await CardWebFacade.SaveToApiAsync(cardDetailModel);
            }

            foreach (var removedCardModel in RemovedCardModels)
            {
                try
                {
                    await CardWebFacade.DeleteAsync(removedCardModel.Id);
                }
                catch (CardApiException e)
                {
                    if (e.StatusCode != 204)
                        throw;
                }
            }

            Snackbar.Add($"Successfully saved '{Model.Title}' collection", Severity.Success);
            Id = collectionId;
        }

        IsSavingProcess = false;
        StateHasChanged();
    }

    private async Task ResetForm()
    {
        form.ResetValidation();
        await OnInitializedAsync();
    }

    private async Task AddNewCard()
    {
        CardModels.Add(
            new CardDetailModel()
            {
                Question = "",
                QuestionTypeEnum = 0,
                CorrectAnswer = "",
                AnswerTypeEnum = 0,
                Description = "",
            }
        );
        IsFilterVisible = true;
        await Task.Yield();
        await JsRuntime.InvokeVoidAsync("scrollToBottom");
    }

    private void RemoveCard(CardDetailModel model)
    {
        CardModels.Remove(model);
        if (model.Id != Guid.Empty)
        {
            RemovedCardModels.Add(model);
        }

        if (!CardModels.Any())
            IsFilterVisible = false;
    }

    private void SearchTermChanged()
    {
    }

    private async Task OnDeleteCollectionBtnClicked()
    {
        if (Id == Guid.Empty)
            GoBackBtn();
        else
        {
            try
            {
                await CollectionWebFacade.DeleteAsync(Id);
            }
            catch (CollectionApiException e)
            {
                if (e.StatusCode != 204)
                    throw;
                Navigation.NavigateTo("/CollectionPage");
            }
        }
    }

    private void GoBackBtn()
    {
        Navigation.NavigateTo("javascript:history.go(-1)");
    }

}