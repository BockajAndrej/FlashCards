@page "/"
@using FlashCards.WebBlazor.Bl.ApiClient
@using FlashUsers.WebBlazor.Bl.Facades
@using IdentityModel

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8 mb-16">
    <MudGrid Justify="Justify.Center">
        <MudItem xs="12" sm="10" md="8" Class="text-center">

            <MudText Typo="Typo.h2" GutterBottom="true">
                <MudIcon Icon="@Icons.Material.Filled.FlashOn" Size="Size.Large" Class="mr-2" Color="Color.Primary"/>
                FlashCards
            </MudText>

            <MudText Style="color: var(--color-text-secondary); margin: 20px auto;" Typo="Typo.h6">
                Your tool for quick and reliable revision. Create, manage and practice your own sets of questions and
                answers.
            </MudText>

            <AuthorizeView>
                <Authorizing>
                    <MudIconButton Class="appbar-specific-text" Icon="@Icons.Material.Filled.Login"
                                   Href="authentication/login"></MudIconButton>
                </Authorizing>
                <Authorized>
                    @if (UserDetailModel != null)
                    {
                        <MudButton Style="width: 100%;" Href="/CollectionPage" Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   Size="Size.Large" Class="mt-4 mr-3">
                            Start learning
                        </MudButton>
                    }
                    else
                    {
                        <MudButton Style="width: 100%;" Href="/UserPageCreate" Variant="Variant.Filled"
                                   Color="Color.Success"
                                   Size="Size.Large" Class="mt-4 mr-3">
                            Create user profile
                        </MudButton>
                    }
                </Authorized>
                <NotAuthorized>
                    <MudButton Style="width: 100%;" Href="/authentication/login" Variant="Variant.Filled"
                               Color="Color.Warning"
                               Size="Size.Large" Class="mt-4 mr-3">
                        Continue to login
                    </MudButton>
                </NotAuthorized>
            </AuthorizeView>
        </MudItem>
    </MudGrid>

    <MudDivider Class="my-10"/>

    <MudGrid Spacing="4">

        <MudItem xs="12">
            <MudText Typo="Typo.h4" Class="mb-4 text-center">
                Features
            </MudText>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background-color: var(--card-background-Primary);" Elevation="2">
                <MudCardContent>
                    <div class="d-flex align-center justify-center mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.LibraryAdd" Size="Size.Large" Color="Color.Info"/>
                    </div>
                    <MudText Typo="Typo.h6" Class="text-center">Custom Collections</MudText>
                    <MudText Typo="Typo.body2" Class="text-center">Create and manage your own sets of flashcards with
                        questions and answers.
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background-color: var(--card-background-Primary);" Elevation="2">
                <MudCardContent>
                    <div class="d-flex align-center justify-center mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.Factory" Size="Size.Large" Color="Color.Success"/>
                    </div>
                    <MudText Typo="Typo.h6" Class="text-center">Practice Mode</MudText>
                    <MudText Typo="Typo.body2" Class="text-center">Interactive interface for effective practice and
                        knowledge testing.
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background-color: var(--card-background-Primary);" Elevation="2">
                <MudCardContent>
                    <div class="d-flex align-center justify-center mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.BarChart" Size="Size.Large" Color="Color.Warning"/>
                    </div>
                    <MudText Typo="Typo.h6" Class="text-center">Clear Statistics</MudText>
                    <MudText Typo="Typo.body2" Class="text-center">Track your progress, success rate, and completed
                        collections.
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard Style="background-color: var(--card-background-Primary);" Elevation="2">
                <MudCardContent>
                    <div class="d-flex align-center justify-center mb-3">
                        <MudIcon Icon="@Icons.Material.Filled.ManageSearch" Size="Size.Large" Color="Color.Error"/>
                    </div>
                    <MudText Typo="Typo.h6" Class="text-center">Easy Management</MudText>
                    <MudText Typo="Typo.body2" Class="text-center">Easy adding, editing, deleting, searching,
                        and filtering of flashcards.
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <AuthorizeView>
        <Authorized>
            <MudDivider Class="my-10"/>

            <MudGrid Spacing="4">

                <MudItem xs="12" sm="6">
                    <MudList T="string" Clickable="false">
                        <MudListItem T="string" Icon="@Icons.Material.Filled.ListAlt" IconColor="Color.Primary">
                            <MudText Typo="Typo.subtitle1">Flashcard Collections List</MudText>
                            <MudText Typo="Typo.body2">Overview of all created sets with the option to open and edit
                                them.
                            </MudText>
                        </MudListItem>
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Description" IconColor="Color.Primary">
                            <MudText Typo="Typo.subtitle1">Collection Detail</MudText>
                            <MudText Typo="Typo.body2">Display of individual flashcards and management of questions and
                                answers.
                            </MudText>
                        </MudListItem>
                    </MudList>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudList T="string" Clickable="false">
                        <MudListItem T="string" Icon="@Icons.Material.Filled.Quiz" IconColor="Color.Primary">
                            <MudText Typo="Typo.subtitle1">Learning Mode (Practice)</MudText>
                            <MudText Typo="Typo.body2">Interactive interface for practicing and testing knowledge (key
                                functionality).
                            </MudText>
                        </MudListItem>
                        <MudListItem Href="/StatisticPage" T="string" Icon="@Icons.Material.Filled.TrendingUp"
                                     IconColor="Color.Primary">
                            <MudText Typo="Typo.subtitle1">Statistics / Progress</MudText>
                            <MudText Typo="Typo.body2">Summarization of user success in individual collections.
                            </MudText>
                        </MudListItem>
                    </MudList>
                </MudItem>
            </MudGrid>
        </Authorized>
    </AuthorizeView>

</MudContainer>

@code {

    [Inject] private AuthenticationStateProvider AuthenticationStateProvider { get; set; } = null!;
    [Inject] private ISnackbar Snackbar { get; set; } = null!;
    [Inject] private UserWebFacade UserWebFacade { get; set; } = null!;
    [Inject] private NavigationManager Navigation { get; set; } = null!;

    [Parameter] public string UserName { get; set; } = "Default User";
    [Parameter] public string UserRole { get; set; } = "Default Role";
    [Parameter] public string ProfileImage { get; set; } = DefaultProfileImage;

    const string DefaultProfileImage = "Images/user.png";

    private bool _openProfile = true;

    private UserDetailModel? UserDetailModel { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        AuthenticationStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
        await GetUserInfo();
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        await GetUserInfo();
        StateHasChanged();
    }

    private async Task GetUserInfo()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var identityUser = authState.User;

            if (identityUser.Identity != null && identityUser.Identity.IsAuthenticated)
            {
                UserDetailModel = await UserWebFacade.GetActualUserAsync();
            }
        }
        catch (UserApiException e)
        {
            if (e.StatusCode != 204)
                throw;
            UserDetailModel = null;
        }
    }

}