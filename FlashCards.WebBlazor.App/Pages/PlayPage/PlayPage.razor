@page "/PlayPage/{Id:guid}"
@using FlashCards.WebBlazor.Bl.ApiClient
@using FlashCards.WebBlazor.Bl.Facades

<MudButton Style="color: var(--card-text-Primary); margin: 20px;" StartIcon="@Icons.Material.Filled.ArrowBack"
           Size="Size.Large" OnClick="OnBackBtnClicked">Back
</MudButton>

<div style="width: 70%; margin: -20px auto">
    <MudStack Row>
        <MudText Style="color: var(--card-text-Primary)">@(_numberOfAnswered+1)/@Cards.Count</MudText>
        <MudSpacer/>
        <MudText Style="color: var(--card-text-Primary)">@((int)(((double)(_numberOfAnswered + 1) / Cards.Count) * 100))%</MudText>
    </MudStack>
    <MudProgressLinear Color="Color.Info" Size="Size.Medium" Rounded="true" Value="@(_numberOfAnswered + 1)" Min="0" Max="@Cards.Count"/>

    <MudStack Style="margin: 10px 0" Row Spacing="4">
        <MudSpacer/>
        <MudIconButton Style="color: var(--card-text-Primary)" Icon="@Icons.Material.Filled.Edit" Variant="Variant.Outlined"></MudIconButton>
        <MudIconButton Style="color: var(--card-text-Primary)"  Icon="@Icons.Material.Filled.Delete"
                       Variant="Variant.Outlined"></MudIconButton>
    </MudStack>

    <div style="perspective: 1000px; width: 80%; height: 400px; margin: 10px auto;" 
         @onclick="FlipCard"> 

        <div class="flip-card-inner" 
             style="@($"transform: rotateY({_rotationAngle}deg)")"> 

            @* === PREDNÁ STRANA === *@
            <MudPaper Class="flip-card-front"
                      Style="border-radius: 10px; background-color: var(--card-background-Primary);"
                      Elevation="6">

                <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
                    <MudText Style="color: var(--card-text-Primary)" Typo="Typo.h4">@CurrentCard?.Question</MudText>
                </div>
            
            </MudPaper>

            @* === ZADNÁ STRANA === *@
            <MudPaper Class="flip-card-back"
                      Style="border-radius: 10px; background-color: var(--card-background-Secondary);"
                      Elevation="6">

                <div style="display: flex; justify-content: center; align-items: center; height: 100%;">
                    <MudStack>
                        <MudText Style="color: var(--card-text-Primary)" Typo="Typo.h4">@CurrentCard?.Question</MudText>
                        <MudDivider/>
                        <MudText Style="color: var(--card-text-Secondary)" Typo="Typo.h5">@CurrentCard?.CorrectAnswer</MudText>
                    </MudStack>
                </div>

            </MudPaper>

        </div>

    </div>

    <MudStack Style="margin: 70px 0" Row Spacing="5" StretchItems="StretchItems.All">
        <MudButton Color="Color.Error" StartIcon="@Icons.Material.Outlined.Cancel" Variant="Variant.Outlined"
                   OnClick="@(() => SelectedAnswear(EnumCompletedLessonAnswerType._1))" Size="Size.Large">Unknown
        </MudButton>
        <MudButton Color="Color.Warning" StartIcon="@Icons.Material.Outlined.QuestionMark" Variant="Variant.Outlined"
                   OnClick="@(() => SelectedAnswear(EnumCompletedLessonAnswerType._2))" Size="Size.Large">50/50
        </MudButton>
        <MudButton Color="Color.Success" StartIcon="@Icons.Material.Outlined.Done" Variant="Variant.Outlined"
                   OnClick="@(() => SelectedAnswear(EnumCompletedLessonAnswerType._0))" Size="Size.Large">Know
        </MudButton>
    </MudStack>
</div>



@code {
    [Inject] private CardWebFacade CardWebFacade { get; set; } = null!;
    [Inject] private CardCollectionWebFacade CardCollectionWebFacade { get; set; } = null!;
    [Inject] public NavigationManager Navigation { get; set; } = null!;

    [Parameter] public Guid Id { get; set; } = Guid.Empty;

    private List<CardListModel> Cards { get; set; } = new();

    private CardListModel? CurrentCard { get; set; }

    private CardCollectionDetailModel? DetailCollection { get; set; }

    private int _numberOfAnswered = 0;
    
    private int _rotationAngle = 0;

    protected override async Task OnInitializedAsync()
    {
        DetailCollection = await CardCollectionWebFacade.GetByIdAsync(Id);
        foreach (var item in DetailCollection.Cards)
        {
            Cards.Add(item);
        }

        CurrentCard = Cards[_numberOfAnswered];
        if (CurrentCard == null)
            Navigation.NavigateTo($"/PlayInfoPage/{Id}");
    }

    private async Task SelectedAnswear(EnumCompletedLessonAnswerType answerType)
    {
        _numberOfAnswered++;
        if (_numberOfAnswered >= Cards.Count)
        {
            Navigation.NavigateTo($"/PlayFinishPage/{Id}");
            return;
        }
        _rotationAngle = 0;
        await Task.Delay(200);
        CurrentCard = Cards[_numberOfAnswered];
    }

    private void FlipCard()
    {
        _rotationAngle = (_rotationAngle == 0) ? 180 : 0;
    }

    private void OnBackBtnClicked()
    {
        Navigation.NavigateTo($"/PlayInfoPage/{Id}");
    }
}